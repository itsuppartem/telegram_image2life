# Ozhivlyator Payment Processor

## Краткое описание

Ozhivlyator Payment Processor – это фоновый микросервис, предназначенный для мониторинга и обработки статусов платежей, инициированных через систему YooKassa. Он обеспечивает синхронизацию данных о платежах с основной базой данных пользователей, начисление виртуальной валюты ("оживашки") после успешной оплаты и информирование пользователей и администраторов о результатах платежных операций.

## Архитектура и технологии

Сервис представляет собой автономный Python-скрипт, работающий в асинхронном режиме для выполнения периодических задач.

*   **Язык и библиотеки:**
    *   Python 3.10+
    *   `motor` 3.3.0+: Асинхронный драйвер для взаимодействия с MongoDB.
        *   *Обоснование:* Обеспечивает неблокирующий доступ к базе данных, что критично для фоновых задач, работающих с внешними API.
    *   `httpx` 0.27.0+: Асинхронный HTTP-клиент для запросов к API основного бэкенд-сервиса Ozhivlyator.
        *   *Обоснование:* Необходим для асинхронного вызова эндпоинта начисления "оживашек".
    *   `python-telegram-bot` 21.1+: Библиотека для взаимодействия с Telegram Bot API.
        *   *Обоснование:* Используется для отправки уведомлений пользователям (через токен основного бота) и администратору (через отдельный токен, если настроен).
    *   `yookassa` 2.10.0+: Официальная SDK от YooKassa для работы с их API.
        *   *Обоснование:* Предоставляет удобный интерфейс для проверки статусов платежей и выполнения операций подтверждения (capture).
    *   `python-dotenv` 1.0.0+: Для загрузки конфигурационных параметров из `.env` файла.

*   **База данных:**
    *   MongoDB: Используется для чтения информации о пользователях и их платежах (вложенный документ `yookassa_payments`), а также для обновления статусов этих платежей.
        *   *Обоснование:* Данные о платежах хранятся непосредственно в документе пользователя в основной базе данных, что упрощает их получение и обновление.

*   **Внешние сервисы:**
    *   **YooKassa API:** Для получения актуальной информации о статусе платежей и для подтверждения платежей, находящихся в статусе `waiting_for_capture`.
    *   **Ozhivlyator Backend API:** Для вызова эндпоинта `/users/{chat_id}/add_ozhivashki/{amount}` с целью начисления "оживашек" пользователю после успешной оплаты.
    *   **Telegram Bot API:** Для отправки уведомлений.

*   **Аутентификация (при взаимодействии с другими сервисами):**
    *   К Ozhivlyator Backend API: Через API-ключ, передаваемый в HTTP-заголовке `api-key`.
    *   К YooKassa API: Через `shopId` и `secretKey`, конфигурируемые при инициализации YooKassa SDK.

## Настройка окружения

Для работы сервиса необходимо определить следующие переменные окружения. Рекомендуется создать файл `.env` в корневом каталоге проекта со следующим содержимым:

```dotenv
# MongoDB Configuration
MONGO_URI="mongodb://user:password@host:port/your_database_name"
MONGO_DB_NAME="ozhivlyator_db"

# Telegram Bot Tokens
ADMIN_NOTIFY_BOT_TOKEN="your_admin_specific_bot_token_for_admin_alerts" # Используется для отправки уведомлений администратору
USER_NOTIFY_BOT_TOKEN="your_main_ozhivlyator_bot_token" # Используется для отправки уведомлений пользователям

# YooKassa Configuration
YOOKASSA_SHOP_ID="your_yookassa_shop_id"
YOOKASSA_SECRET_KEY="your_yookassa_secret_key"

# Admin Configuration
ADMIN_CHAT_ID="your_telegram_admin_chat_id" # ID чата администратора для получения уведомлений

# Ozhivlyator Backend API Configuration (для начисления "оживашек")
API_URL="http://localhost:8000" # URL развернутого Ozhivlyator Backend
API_KEY="your_api_key_for_ozhivlyator_backend" # API-ключ для аутентификации на Ozhivlyator Backend

# Logging (optional, defaults to enabled in code if variable is missing or not "False")
# LOGGING_ENABLED="True"
```

## Основные выполняемые задачи

Данный сервис работает в фоновом режиме и не предоставляет внешнего API. Его основная задача – периодическая проверка и обработка статусов платежей.

### 1. Мониторинг и обновление статусов платежей YooKassa

*   **Описание:** Сервис с заданной периодичностью (по умолчанию, цикл проверки запускается примерно каждые 10 секунд) выполняет следующие действия:
    1.  Запрашивает из MongoDB всех пользователей, у которых есть незавершенные (статус не `succeeded` или `canceled` с флагом `generations_added: true`) или необработанные записи о платежах в поле `yookassa_payments`.
    2.  Для каждого такого платежа (`payment_id`) обращается к YooKassa API для получения его актуального статуса.
*   **Логика обработки в зависимости от статуса в YooKassa:**
    *   **Статус `succeeded` (успешно):**
        *   Если "оживашки" по этому платежу еще не были начислены (проверяется флаг `yookassa_payments.{payment_id}.generations_added` в MongoDB):
            *   Выполняется `POST` запрос на эндпоинт `{API_URL}/users/{chat_id}/add_ozhivashki/{amount}` основного бэкенда Ozhivlyator для начисления купленного количества "оживашек". Количество (`amount`) берется из данных платежа в MongoDB.
            *   В случае успешного начисления через API, пользователю отправляется уведомление об успешной оплате и зачислении "оживашек". Администратору также отправляется уведомление об успешной операции.
            *   В MongoDB для данного платежа устанавливается флаг `generations_added = True`.
        *   Статус платежа в MongoDB обновляется на `succeeded`.
    *   **Статус `canceled` (отменен):**
        *   Если статус в MongoDB еще не был `canceled`:
            *   Пользователю отправляется уведомление об отмене платежа.
            *   Администратору отправляется уведомление об отмене платежа с указанием причины (если доступна от YooKassa).
        *   Статус платежа и детали отмены в MongoDB обновляются. Устанавливается флаг `generations_added = True` для исключения из дальнейшей обработки.
    *   **Статус `waiting_for_capture` (ожидает подтверждения):**
        *   Сервис автоматически инициирует операцию подтверждения (capture) платежа через YooKassa API с использованием уникального ключа идемпотентности.
        *   Статус платежа в MongoDB обновляется на результат операции capture (обычно `succeeded` или `canceled`).
        *   Администратор уведомляется о результате операции подтверждения.
    *   **Платеж не найден в YooKassa (YooKassaNotFoundError):**
        *   Статус платежа в MongoDB обновляется на `canceled` с пометкой о причине (например, `not_found_in_yookassa`).
        *   Администратор уведомляется об этой ситуации.
    *   **Другие статусы:**
        *   Статус платежа в MongoDB обновляется на текущий статус из YooKassa. Обработка (начисление, уведомления) откладывается до перехода платежа в финальный статус (`succeeded` или `canceled`).