# Ozhivlyator Background Worker

## Краткое описание

Ozhivlyator Background Worker – это фоновый микросервис, выполняющий периодические задачи для поддержки основного приложения "Ozhivlyator". Он отвечает за отправку уведомлений пользователям, таких как напоминания о ежедневных бонусах и предложения персональных скидок, с целью повышения вовлеченности.

## Архитектура и технологии

Сервис реализован на Python с использованием асинхронного подхода для взаимодействия с базой данных и Telegram API.

*   **Язык и фреймворк/библиотеки:**
    *   Python 3.10+
    *   `motor` 3.3.0+ (асинхронный драйвер для MongoDB)
    *   `python-telegram-bot` 20.8+ (для отправки сообщений через Telegram Bot API)
    *   `python-dotenv` 1.0.0+ (для управления конфигурацией)
    *   *Обоснование:* Асинхронный стек на Python (`asyncio`, `motor`) выбран для эффективной обработки I/O-операций (запросы к MongoDB, отправка уведомлений в Telegram) без блокировки основного потока. `motor` обеспечивает неблокирующий доступ к базе данных пользователей. `python-telegram-bot` используется для прямого взаимодействия с Telegram API для отправки сервисных сообщений.

*   **База данных:**
    *   MongoDB: Используется для чтения данных пользователей (например, время регистрации, количество генераций, баланс, статус получения бонусов/скидок) для определения целевой аудитории для уведомлений.
        *   *Обоснование:* MongoDB, используемая основным бэкенд-сервисом, содержит всю необходимую информацию о пользователях для работы воркера.

*   **Внешние сервисы:**
    *   Telegram Bot API: Для отправки сообщений пользователям.

## Настройка окружения

Для работы сервиса необходимо определить следующие переменные окружения. Создайте файл `.env` в корне проекта со следующим содержимым:

```dotenv
# MongoDB Configuration
MONGO_URI="mongodb://user:password@host:port/your_db_name"
MONGO_DB_NAME="ozhivlyator_db"

# Telegram Bot Token (token of the main Ozhivlyator bot)
TELEGRAM_BOT_TOKEN="your_telegram_bot_token_from_botfather"

# Ozhivlyator Backend API (currently not used by this worker, but defined for potential future use)
# API_URL="http://localhost:8000"
# API_KEY="your_backend_api_key"

# Logging (optional, defaults to enabled in code if var is missing or not "False")
# LOGGING_ENABLED="True"
```

## Основные выполняемые задачи

Данный сервис не предоставляет внешнего API, а выполняет фоновые задачи по расписанию.

### 1. Предложение скидки на "оживашки"

*   **Описание:** Сервис периодически (по умолчанию каждые 15 минут) проверяет пользователей на соответствие критериям для получения персональной скидки.
*   **Критерии для пользователя:**
    1.  Совершил ровно одну генерацию изображений.
    2.  Текущий баланс "оживашек" равен нулю.
    3.  С момента совершения первой (и единственной) генерации прошло более 24 часов.
    4.  Пользователю ранее не предлагалась скидка (флаг `discount_offered` в базе данных имеет значение `False`).
*   **Действие при соответствии критериям:**
    1.  Пользователю отправляется сообщение в Telegram от имени основного бота с предложением специальной цены на пакет "оживашек".
    2.  В базе данных для данного пользователя устанавливается флаг `discount_offered = True`, чтобы предотвратить повторную отправку предложения.

### 2. Напоминание о ежедневном бонусе

*   **Описание:** Сервис один раз в день (по умолчанию проверка запускается после 11:00 по времени сервера) идентифицирует пользователей, которые могут получить ежедневный бонус.
*   **Критерии для пользователя:**
    1.  Зарегистрирован в боте менее 3 дней назад.
    2.  Не получал ежедневный бонус за текущие сутки (флаг `daily_bonus_claimed_today` в базе данных имеет значение `False`).
*   **Действие при соответствии критериям:**
    1.  Пользователю отправляется сообщение в Telegram от имени основного бота с напоминанием о возможности забрать ежедневный бонус (+1 "оживашка"). Сообщение информирует, что бонус доступен в первые 3 дня после регистрации и его можно получить в разделе "Бонусы" главного меню бота.